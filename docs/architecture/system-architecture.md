# 海关案件数据分析平台 - 系统架构设计

## 1. 架构概览

### 1.1 设计原则

- **微服务架构**: 每个原子能力 (S1-S12) 独立部署，支持弹性伸缩
- **事件驱动**: 采用消息队列解耦各服务，支持异步处理
- **多模态处理**: 支持 IM、图片、语音、视频、PDF、Excel、邮件等多种数据类型
- **混合存储**: PostgreSQL + Neo4j + Milvus + Elasticsearch 的多数据库架构
- **可追溯性**: 完整的证据链路追踪和审计日志

### 1.2 系统分层架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      前端展示层 (Frontend)                        │
│   案件管理 | 证据可视化 | 图谱展示 | 报告生成                      │
├─────────────────────────────────────────────────────────────────┤
│                      API 网关层 (API Gateway)                    │
│   认证授权 | 流量控制 | 路由分发 | 请求日志                        │
├─────────────────────────────────────────────────────────────────┤
│                      业务服务层 (Business Services)              │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│   │ 案件管理服务 │  │ 证据管理服务 │  │ 分析挖掘服务 │            │
│   └─────────────┘  └─────────────┘  └─────────────┘            │
├─────────────────────────────────────────────────────────────────┤
│                      原子能力层 (Atomic Services)                │
│   S1-S4: 多模态解析  │  S5-S7: 文档解析  │  S8-S12: 后端服务      │
├─────────────────────────────────────────────────────────────────┤
│                      数据存储层 (Data Storage)                   │
│   PostgreSQL │ Neo4j │ Milvus │ Elasticsearch │ MinIO          │
└─────────────────────────────────────────────────────────────────┘
```

## 2. 核心组件设计

### 2.1 数据接入层

#### 2.1.1 文件接收服务
- 支持 HTTP/HTTPS 协议上传
- 支持 SFTP 协议批量传输
- 文件大小限制：单文件 500MB，批量 10GB
- 支持断点续传

#### 2.1.2 IM 数据接入
- 微信/WhatsApp/Telegram 等平台导出格式解析
- 时间线重建与消息去重
- 多媒体附件自动提取

### 2.2 解析服务集群

#### 2.2.1 IM 多模态解析 (S1-S4)

| 服务编号 | 服务名称 | 技术栈 | 输出格式 |
|---------|---------|--------|---------|
| S1 | 对话时序解析 | Python + 正则引擎 | JSON 时间线 |
| S2 | 图片解析 | PaddleOCR + 图像分类 | 结构化文本+元数据 |
| S3 | 语音解析 | ASR (FunASR) | 转写文本+时间戳 |
| S4 | 视频解析 | FFmpeg + ASR | 关键帧+转写文本 |

#### 2.2.2 文档解析 (S5-S7)

| 服务编号 | 服务名称 | 技术栈 | 输出格式 |
|---------|---------|--------|---------|
| S5 | PDF/图片表格 | PaddleOCR + 表格识别 | JSON 表格结构 |
| S6 | Excel 解析 | Apache POI / openpyxl | 结构化数据表 |
| S7 | 邮件解析 | Python email 模块 | 元数据+正文+附件 |

#### 2.2.3 后端处理服务 (S8-S12)

| 服务编号 | 服务名称 | 功能描述 |
|---------|---------|---------|
| S8 | 实体抽取服务 | NER + LLM 实体识别，人/地/物/时间标准化 |
| S9 | 关系图谱服务 | 实体关系抽取，Neo4j 图谱构建 |
| S10 | 轻量索引服务 | ES 倒排索引 + Milvus 向量索引 |
| S11 | 质量校验服务 | 规则校验 + 置信度评估 |
| S12 | 落库归档服务 | 多数据库写入 + 冷热数据分层 |

### 2.3 证据挖掘引擎

#### 2.3.1 挖掘分支策略

```
                    ┌─────────────────────┐
                    │   字段候选池入口     │
                    └──────────┬──────────┘
                               │
                    ┌──────────▼──────────┐
                    │   结构化程度判断     │
                    └──────────┬──────────┘
                               │
        ┌──────────────────────┼──────────────────────┐
        │                      │                      │
        ▼                      ▼                      ▼
┌───────────────┐    ┌───────────────┐    ┌───────────────┐
│  高结构化     │    │   混合型      │    │  低结构化     │
│  (SQL/BI)     │    │ (规则+LLM)    │    │  (LLM/图谱)   │
└───────────────┘    └───────────────┘    └───────────────┘
```

#### 2.3.2 规则引擎 (M1)
- 时间窗匹配
- 订单/票据号匹配
- 人物主体归并
- 金额与币种校验
- 商品数量一致性
- 物流路径规则
- 票据凭证规则
- 跨源一致性校验
- 异常模式检测

#### 2.3.3 字段融合服务 (M2)
- 结构化字段对齐
- 商品语义抽取
- 价格与交易语义
- 人物角色语义
- 证据来源融合
- 语义补证建议

#### 2.3.4 图谱分析服务 (M3)
- 事件链语义抽取
- 关系强度计算
- 上下游/团伙识别
- 多轮条件更新

### 2.4 复核与输出

#### 2.4.1 人工审核流程
- 任务分派与会签
- 抽检比例控制
- 高风险命中人工确认
- 误报/确认反馈闭环

#### 2.4.2 证据大表定稿
- 冲突字段人工确认
- 关键字段签名
- 草表→定稿版本控制

#### 2.4.3 输出报告
- 简版/详版/审计版报告模板
- 加密打包与水印
- 临时令牌访问
- 二次审批流程

## 3. 数据架构

### 3.1 混合存储策略

| 存储类型 | 数据库 | 用途 | 数据示例 |
|---------|--------|------|---------|
| 关系型 | PostgreSQL | 结构化主数据 | 案件、人员、订单 |
| 图数据库 | Neo4j | 关系网络 | 人物关系、资金链路 |
| 向量库 | Milvus | 语义检索 | 商品相似度、文本嵌入 |
| 搜索引擎 | Elasticsearch | 全文检索 | IM 消息、文档内容 |
| 对象存储 | MinIO | 原始文件 | 图片、视频、附件 |

### 3.2 数据分区策略

```
/case/{case_id}/
├── raw/                 # 原始文件
│   ├── im/              # IM 导出数据
│   ├── documents/       # 文档文件
│   └── media/           # 多媒体文件
├── parsed/              # 解析结果
│   ├── timeline.json    # 时间线
│   ├── entities.json    # 实体抽取
│   └── tables/          # 表格数据
├── evidence_pool/       # 字段候选池
│   └── fields_{ts}.json
└── output/              # 输出报告
    ├── draft/           # 草表
    └── final/           # 定稿
```

## 4. 技术选型

### 4.1 后端技术栈

| 层次 | 技术选型 | 说明 |
|------|---------|------|
| API 框架 | FastAPI / Spring Boot | 高性能异步 API |
| 消息队列 | Apache Kafka | 事件驱动解耦 |
| 任务调度 | Celery / Apache Airflow | 批处理与调度 |
| 容器化 | Docker + Kubernetes | 弹性伸缩 |
| 监控 | Prometheus + Grafana | 性能监控 |

### 4.2 AI/ML 组件

| 组件 | 技术选型 | 用途 |
|------|---------|------|
| OCR | PaddleOCR | 文字识别 |
| ASR | FunASR / Whisper | 语音转写 |
| NER | BERT + 自定义词典 | 实体识别 |
| LLM | Claude API / 本地模型 | 语义理解 |
| 图像分类 | ResNet / EfficientNet | 图片分类 |

### 4.3 数据库版本

| 数据库 | 版本 | 部署模式 |
|--------|------|---------|
| PostgreSQL | 15+ | 主从复制 |
| Neo4j | 5.x | 因果集群 |
| Milvus | 2.x | 分布式集群 |
| Elasticsearch | 8.x | 3 节点集群 |
| MinIO | 最新 | 分布式模式 |

## 5. 安全架构

### 5.1 认证授权
- OAuth 2.0 + JWT
- 基于角色的访问控制 (RBAC)
- API 密钥管理

### 5.2 数据安全
- 传输加密 (TLS 1.3)
- 存储加密 (AES-256)
- 敏感数据脱敏

### 5.3 审计日志
- 操作日志全量记录
- 数据访问审计
- 异常行为检测

## 6. 性能指标

### 6.1 服务等级协议 (SLA)

| 指标 | 目标值 | 说明 |
|------|--------|------|
| 可用性 | 99.9% | 年度可用性 |
| 响应时间 | P95 < 500ms | API 响应 |
| 解析吞吐 | 1000 文件/小时 | 文档解析 |
| 并发用户 | 100 | 同时在线 |

### 6.2 资源配置

| 服务 | CPU | 内存 | 实例数 |
|------|-----|------|--------|
| API 网关 | 4 核 | 8GB | 2 |
| 解析服务 | 8 核 | 16GB | 4+ |
| 图谱服务 | 4 核 | 16GB | 2 |
| PostgreSQL | 8 核 | 32GB | 2 |
| Neo4j | 8 核 | 32GB | 3 |
| Milvus | 8 核 | 32GB | 3 |

---

*版本: 1.0.0 | 更新日期: 2026-02-15*
